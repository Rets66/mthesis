\section{脅威モデル}
\label{sec:dns-tunneling}
本章では，はじめにDNSの概要について述べる．
次に，本研究における脅威モデルであるDNSトンネリングについて説明する．

\subsection{DNSの概要}
\label{sec:dns-protocol}

DNSは，ドメイン名に関連づけられたリソースレコードを解決するシステムである~\cite{rfc1034, rfc1035}．
DNSがユーザから問い合わせられたドメイン名のIPアドレスを解決することで，ユーザは識別しづらいIPアドレス(IPv4:``93.184.216.34", IPv6:``2606:2800:220:1:248:1893:25c8:1946")を直接入力することなく，サーバにアクセスすることができる．
このような利便性を実現するDNSによる名前解決の機能は，ユーザがインターネットを利活用する上で極めて重要である．

\subsubsection{名前空間}
DNSにおいて，各種リソースレコードが関連づけられるドメイン名は，ルートを頂点とする逆ツリー構造で構成されている．
ドメインの序列を表記する際には，上位ドメインを右に，下位ドメインを左にする．


``example.com."を例にとると，ドットで表記されるルートが最も右に位置し，ルートの一つ下層に位置するTLD(Top Level Domain)である``com"が後続する．
ドメインの区切りには，ドットが使用され，TLDの一つ下層に位置づくSLD(Second Level Domain)として``example"が連結していることを``example.com."は表している．
図~\ref{fig:dns-architecture}に示す通り，全てのドメインには，ゾーンと呼ばれる名前空間があり，このゾーンはそれぞれのドメインに配置される権威サーバによって管理される．
DNSには，委譲という仕組みを利用することでゾーンを分割できる特徴がある．
例えば，``example"と``google"というドメインが連結している``com."について考える．
委譲の仕組みを使用しなかった場合には，``com."が``www.example.com."や``mail.google.com."といった``example.com."と``google.com."に連結した全てのドメイン名を管理する．
しかし，``com."がそれぞれのドメインにゾーンを委譲した場合，先の``www.example.com"は``example.com."が管理し，``mail.google.com."は``google.com."が管理することになる．
DNSでは，この委譲の仕組みを利用することで，ゾーンの肥大を抑止させ，サーバの負荷分散を実現する設計になっている．

\begin{figure}[th]
 \centering
 \includegraphics[width=12.0cm]{figure/dns-architecture.png}
 \caption[ゾーンごとに分割された名前空間]{ゾーンごとに名前空間を色で区分した様子．Root権威が管理するオレンジで表現されたゾーンには，comやorgをはじめとしたドメインが含まれる．Rootの直下に位置するTLDの一つであるcomドメインは，青色で囲まれたexampleドメインを含むゾーンを管理する．comに紐づけられるexampleドメインは，wwwなどを管理する．}
 \label{fig:dns-architecture}
\end{figure}

\textbf{アーキテクチャ}\\
DNSは，クライアント・サーバアーキテクチャで構成され，機能に基づき３つのサービスに分類することができる．
\begin{itemize}
 \item スタブリゾルバ
 \vspace{-3mm}
 \item フルサービスリゾルバ
 \vspace{-3mm}
 \item 権威サーバ
\end{itemize}

スタブリゾルバは，名前解決の問い合わせを行うクライアントノードである．
フルサービスリゾルバ(キャッシュサーバ・リカーシブサーバとも呼称される)は，スタブリゾルバに代わって，リソースレコードを保持する権威サーバに問い合わせるクライアントノードである．
名前解決をする際には，ルートから順にTLD，SLDという具合に権威サーバに再帰的に問い合わせることで，最終的に目的のドメイン名に関するリソースレコード情報を取得する．
この時，はじめのルート権威サーバのアドレスは``root.hints"と呼ばれるファイルに基づいて問い合わせるが，それより下位のドメインについては，上位の権威サーバが次の権威サーバのアドレスを応答することで名前解決のチェーンを繋げている．
すなわち，ルート権威サーバがTLDの権威サーバのアドレスを応答し，TLDの権威サーバがSLDの権威サーバーのアドレスを応答していく具合である．
権威サーバは，リソースレコードを保持するサーバノードであり，フルサービスリゾルバからの問い合わせ依頼に応答する．

\subsubsection{ドメイン名とリソースレコード}
%TLDごとに登録するプロセスや必要書類，金額は異なり，上位
ルートからホストまでの階層構造の繋がりは，``label3.label2.label1."のように右から左方向に連結することで表現される．
この表記は，FQDN(Fully Qualified Domain Name)と呼ばれ，右端のドットがルート，``label1"がTLD，``label2"がSLDを表現し，ドメインごとの階層にはドットが使用される．
ドメインの階層構造において，全てはルートを頂点としているため，ルートを意味するドットを略記した``label3.label2.label1"が，一般にはドメイン名として解釈される．
次にドメイン名に関する長さおよび使用できる文字列について説明する．
\vspace{-1pt}
\begin{eqnarray}
 (LabelD).(LabelC).(LabelB).(LabelA). \label{eq:domain-name} \\
 (Length) + (LabelD) + ... + (length) + (LabelB) + (length) + (LabelA) + 0 \label{eq:label-name} \\ 
 1 + (Max 63) + ... + 1 + (Max 63) + 1 + (Max 63) + 1 = (Max 255) \label{eq:length-label-domain}
\end{eqnarray}

(\ref{eq:domain-name})は，複数のラベルで構成されたドメイン名の例である．
(\ref{eq:label-name})は，Questionヘッダーに注入される際のそのドメイン名を表すデータである．
Questionセクションでは，ドメイン名を表す際にドットは省略され，ラベルの長さとラベル名，そしてドメイン名の終わりを意味する``0"で表現される．
(\ref{eq:length-label-domain})は，ラベルの長さとラベル名のサイズを表す．
ラベルの長さは，1バイトのサイズで表現され，ラベル自体の最大長は63バイトである．
Questionセクションの最大長255バイトは，ラベルの長さとラベル，そしてドメイン終了を表す``0"を含めた長さである．
このため，最初のラベル長を表す1バイトとドメイン名の終了を意味する``0"を表すための1バイトを差し引いた253バイトが，実際のドメイン長の最大長である．

ラベルには，数字とアルファベットおよびハイフン(``-")を使用することができ，ラベル中に大文字・小文字の区別はない．
他方で，アルファベットなどのASCII以外にも，国際化ドメイン名(IDN: Internationalized Domain Name)を使用すると日本語やアラビア語なども使用することができる．
IDNは，Punnycode\footnote{Punnycode: Unicode文字列を一意かつ可逆的にASCII文字列に変換する符号化方式}などのエンコーディング手法に基づき，DNSクエリする際にはASCIIコードに変換される~\cite{idn}．

\input{table/resource-record}
\newpage
ドメイン名に関連づけられる情報はリソースレコードと呼ばれ，目的に応じて複数のタイプが定義されている．
例えば，ドメイン名にIPv4アドレスを関連づけることを考える．
そのドメインの権威サーバは，関連づけたいIPv4アドレスをレコードタイプAとして，ゾーンファイルに記述する．
クライアントは，ドメイン名とレコードタイプとしてAを指定しサーバに問い合わせることで，権威サーバが事前に登録したAレコードに記述されたアドレスを取得することができる．
DNSでは，IPv4アドレス以外にも様々な情報をドメイン名に関連づけることができる．
代表的なソースレコードのタイプを表~\ref{tab:resource-record}で示す．

次に，DNSのパケットフォーマットについて説明する．
図~\ref{fig:dns-format}で示すように，DNSのパケットは５つのセクションに分けられる．
\begin{figure}[bh]
 \centering
 \includegraphics[scale=0.7]{figure/dns-format.png}
 \caption{DNSのパケットフォーマット}
 \label{fig:dns-format}
\end{figure}
クライアントがDNSの名前解決をする際，解決したいレコードタイプとそのドメイン名は図~\ref{fig:dns-answer}におけるQnameフィールに含まれる．
各フィールドはサイズが決まっており，Qnameフィールドが最大長255バイト，リソースレコードのタイプを表すQtypeフィールドとクエリクラスを表すQclassフィールドがそれぞれ2バイトとなっている．
\begin{figure}[th]
 \centering
 \includegraphics[scale=0.6]{figure/dns-answer.png}
 \caption{DNSのパケットのAnswerセクション(bytes)}
 \label{fig:dns-answer}
\end{figure}

\subsubsection{名前解決の仕組み}
\label{sec:dns-mechanism}

参考として，クライアントが``www.example.com"のIPv4アドレスを解決する場合を考える．
\begin{figure}[H]
 \centering
 \includegraphics[width=12.0cm]{figure/dns-name-resolution.png}
 \caption{DNSによる名前解決}
 \label{fig:dns-name-resolution}
\end{figure}
はじめに，クライアントとなるスタブリゾルバは，スタブリゾルバと同一セグメント内のフルサービスリゾルバもしくは，ネットワークセグメントに依らないどこからでもアクセスできるフルサービスリゾルバ(オープンリゾルバ，パブリックリゾルバとも呼称される)に問い合わせる．
フルサービスリゾルバは，その名前解決クエリが過去に解決したものでないかキャッシュデータを確認する．
キャッシュにヒットした場合にはキャッシュの情報をクライアントに応答され，ヒットしなかった場合には，root.hintsファイルを参照しルート権威サーバにリクエストパケットを転送する．
クエリ(問い合わせ)を受け取ったルート権威サーバは，``com"ドメインを委譲した権威サーバのアドレスを応答する．
次に，フルサービスリゾルバは，``com"の権威サーバに対し同じクエリを転送する．
``com"の権威サーバは，``example.com"ドメインを委譲した権威サーバのアドレスを応答する．
フルリゾルバは，``example.com"の権威サーバに同じクエリを転送する．
``example.com"の権威サーバは，保持するゾーンファイルからクエリされたドメインのリソースレコードについて探索し，探索の結果としてレコード情報をフルサービスリゾルバに応答する．
フルサービスリゾルバは，権威サーバから応答された情報をスタブリゾルバに転送することで，問い合わせられた名前は解決される．
DNSによる名前解決の一連の動作を図~\ref{fig:dns-name-resolution}で示す．


%リソースレコードのタイプごとの使用頻度を知りたい
% タイプごとの説明を充実させるのは，重要かもしれない


\newpage
\subsection{DNSトンネリング}
\label{sec:dns-tunneling}
%DNSトンネリングが脅威となりうる点に関する説明
%Botnetなどに使用されることについて言及するべき
%概念
現在の情報流出を目的としたマルウェアのほとんどは，秘匿通信手法を利用している~\cite{asaf}．
DNSトンネリングは，そのような秘匿通信の代表的な手法である．
DNSトンネリングは，DNSをデータ転送のメディアとした秘匿通信手法の総称であり，転送元と転送先の方向によって二つに分類することができる．
スタブリゾルバから権威サーバへの通信のDNS Exfiltrationと，権威サーバからスタブリゾルバへの通信のDNS Infiltrationである．
%DNSトンネリングという手法は，ポートスキャンで知られるNmapのメーリングリストだとされている．
DNSトンネリングは，以下に示すDNSの特性に基づいる．

\begin{itemize}
 \setlength{\itemsep}{0pt}
 \item 通常のインターネットの利活用において名前解決は必要な機能であるため，一般にDNSのサービスポートが閉ざされることがない
 \item 名前解決のトラフィックはほとんどのサービスに先立って発生するため，クエリログが肥大化しやすく長期のログ保存が困難である
 \item パケットフォーマットの構造において，任意の文字列を注入できるフィールドを保持する
\end{itemize}

DNSトンネリングがデータ転送のキャリアとするフィールドは，クエリのQuestionセクションのQnameと，AnswerセクションのRdataである．
QuestionセクションのQnameフィールドを利用することで，スタブリゾルバから権威サーバ方向にデータを転送できる．
この方向の通信は，ビーコン通信やターゲットから取得した情報を外部に漏えいさせるといった攻撃の最終目的を達成するのに使われる．
また，AnswerセクションのRdataフィールドを利用することで，データを転送することができる．
この通信は，ターゲットネットワーク内のホストに潜伏したマルウェアなどへの命令コードを送信するのに使われる．
さらに，この二つのキャリアを利用することが双方向の通信路を確保できるため，C2通信を実施することも可能である．
%DNSトンネリング手法が脅威なのは，IDS・IPSなどの検知システムにフィルタリングされにくく，クエリ頻度を長期化させた場合解析を迂回することができる点である．

DNSトンネリング手法が初めて一般に公開されたのは，1998年に，ポートスキャンで知られるNmapのメーリングリストだとされている~\cite{nmap, maarten}．
2004年には，Dan KaminskyがOzymanDNS~\cite{ozymandns}と呼ばれるDNSトンネリングの実装を公開した~\cite{dan-kaminsky}ことをきっかけに広く知られるようになった．
それ以降，数多くのDNSトンネリングの実装~\cite{heyoka, iodine, dnscat2, tcp-over-dns, dnscat, denise, dns-shell, dnsbotnet, dnscapy, dohtunnel, godoh, dohc2, magictunnelandroid, dns2tcp, tuns}が公開され，実際のサイバー攻撃に悪用されるようになっている．

\subsubsection{DNS Exfiltration}
\label{sec:dns-exfiltration}
% トンネリング実装のUpstreamは，どのくらいなのだろうか
\begin{figure}[bhtp]
 \centering
 \includegraphics[scale=0.6]{figure/dns-exfiltration.png}
 \caption[DNS Exfiltrationの概略図]{DNS Exfiltrationメソッドに基づいて，ドメイン名のラベル部に任意文字列がサブドメインとして注入されたDNSクエリが，イントラネット内のスタブリゾルバからインターネット上の権威サーバ(``exfil.com")に転送される様子}
 \label{fig:dns-exfiltration}
\end{figure}

本項では，スタブリゾルバから権威サーバ方向にデータを転送する手法であるDNS Exfiltrationの詳細について説明する．
DNS Exfiltrationは，名前解決として問い合わせられるドメイン名が，そのドメインのゾーンを管理する権威サーバに転送される仕組みを利用した手法である．
DNSでは，ドメイン名に関連づけられるリソースレコードの情報は，そのドメインをゾーンとする権威サーバが保持しており，ルートから再帰的に問い合わせていくことでその権威サーバからの応答を受け取る．
このため，問い合わせられたドメイン名が実在しない場合でも，再帰問い合わせの仕組みに従って，そのドメイン名の最後の権威サーバまで転送されることになる．
権威サーバでは通常，クエリされたドメイン名の実在有無に寄らず，問い合わせられたクエリ情報をログとして管理する．
このような特性に踏まえてDNSを利用すると，DNSクエリのドメイン名のラベルに組織外ネットワークに転送したい文字列を注入することで，組織外ネットワーク上に設置された権威サーバにそのデータを転送することができる．
これがDNS Exfiltrationの動作原理である．

このような仕組みのDNS Exfiltrationを動作させるには，宛先となる権威サーバを用意する必要があり，グローバルなドメインを取得することを前提としている．
第~\ref{sec:dns-mechanism}項で述べるように，ドメイン名の最大長は253バイトであり，その内ラベルの最大長は63バイトまでという制約がある．
そのため，DNS Exfiltration手法を用いてデータを転送する際には，TLDのラベルと宛先権威サーバのラベルもしくはSLDラベルと権威サーバのラベルを差し引いたサイズが実際に転送できる最大長となる．
また，任意の文字列をDNS Exfiltrationメソッドを用いて外部に転送するにあたり，転送キャリアであるドメイン名における文字列制約を満たすように転送したいデータに前処理を施す必要がある．
ドメイン名に使用できる文字列は，第~\ref{sec:dns-mechanism}項で述べるように，``a"から``z"までのアルファベットと``0"から``9"までの数字と先頭以外のハイフン``-"記号である．
この文字列制約については，転送したいデータをバイナリデータに変換し，そのバイナリデータをラベルとして印字可能なASCIIコードに変換することでその制約を満たすことができる．
この前処理について，既存のDNSトンネリング実装の多くがBase Encoding~\cite{rfc4648}を用いている．
%使用するエンコーディング手法によって，データの圧縮率は異なる．
この処理によって，転送データがバイナリデータである際にも転送効率上げたり，ラベルの文字列制約を満たさないデータも転送することができる．
また，エンコーディングのラベルは，自然言語とは異なるため，メッセージの意味抽出を困難にすることにも機能する．

ここで，DNS Exfiltrationを用いて，あるイントラネット内のホストからイントラネット外のホストにデータを転送することを考える．
転送される宛先となるイントラネット外のホストには，``exfil.com"より下位の全ての名前空間をゾーンとする権威サーバ(``exfil.com")を指定する．
転送したい文字列にエンコーディング前処理を施した後，``用意した文字列.exfil.com"という具合に文字列をラベルとして含めることで，ドメイン名が用意できる．
適当なリソースレコードタイプを指定し，DNSクエリとして転送すると，その権威サーバにはログとして，文字列を含んだドメイン名を取得する．
最後に，受け取ったサーバサイドは，前処理と逆のデコード処理を施すことで，オリジナルのデータを取得できる．
以上のように再帰問い合わせとラベルという転送キャリア，エンコーディング処理を組み合わせることで，イントラネット内のホストから外部ネットワークに任意の情報を転送することができる．
これが，DNS Exfiltrationの動作メカニズムである．
図~\ref{fig:dns-exfiltration}に，DNS Exfiltrationのメカニズムを図解した様子である．

%具体的な脅威モデル
%検知バイパス手法 : スループット（パフォーマンス）を下げることによる秘匿性，一般的なホスト名を使った対応表

%1998年4月，DNSトンネリングの手法は，NmapのBugtraqメーリングリストにて初めて公になったとされている\cite{bugtraq}．

\subsubsection{DNS Infiltration}
\label{sec:dns-infiltration}

\begin{figure}[bhtp]
 \centering
 \includegraphics[scale=0.6]{figure/dns-infiltration.png}
 \caption[DNS Infiltrationの概略図]{TXTレコードに登録された情報について，DNSクエリで問い合わせることで権威サーバから命令情報を取得している様子}
 \label{fig:dns-infiltration}
\end{figure}

本項では，権威サーバからスタブリゾルバ方向にデータを転送する手法であるDNS Infiltrationの詳細について説明する．

DNS Infiltrationは，DNSにおける幾つかのリソースレコードが任意の文字列を記述できる設計を利用したデータ転送手法である．
ドメイン名に関連づけられた情報を管理・提供する権威サーバは，ゾーンファイルに関連づけたい情報を記述する．
リソースレコードには，レコード情報を検証する機構が備わっていないため，任意の文字列を登録することができる．
特に，記法が決まっていないTXTタイプやNULLタイプなどもあり，DNS Infiltrationではこのようなレコードタイプに転送したいデータを登録しておく．
このようにして登録されたレコード情報について，名前解決問い合わせすることによって，インターネット(権威サーバ)からイントラネット(スタブリゾルバ)にデータを転送することができる．
DNS Infiltrationとして利用され得るレコードタイプについて，これまでのトンネリング実装で使用されたものに基づいてまとめたのが，表~\ref{tab:infil-rtype}である．
%zonefileを説明
%Infilとして使用される脅威のあるRtypeを列挙

\input{table/infil-rtype}
NS・CNAME・MXレコードでは，DNS Exfiltrationと同じ要領でドメイン名のラベルに転送したい文字列を注入できる．
また，NULL・TXT\footnote{EDNS0を使用する場合，65535bytesが最大長となる．}・SRV・DNSKEYを用いる場合には，レコード構文に指定がないため任意の文字列をそのまま注入できる．
最後に，A・AAAA・PTRレコードを用いる場合には，転送したい文字列を数字に変換させた後に，ドット(.)区切りもしくはコロン(:)区切りで注入できる．

TXTレコードタイプを用いてDNS Infiltrationすることを考える．
(\ref{eq:infil-txt})は，TXTレコードを用いてホストで実行させるLinuxコマンドを転送する例である．
転送されるunameプログラムは，システム情報を取得するプログラムである．
実行結果をDNS Exfiltration手法を用いて転送することで，ホストマシンにおけるシステムのカーネルバージョンやプロセッサの種類などの情報を取得することができる．
\begin{eqnarray}
 www.exfil.com. \qquad IN \quad TXT \quad uname \ -ap
 \label{eq:infil-txt}
\end{eqnarray}
次に，スタブリゾルバは，``www.exfil.com"の``TXT"レコードタイプを通常通り問い合わせる．
再帰問い合わせの仕組みに基づいて，そのDNSクエリは``exfil.com"まで転送され，ゾーンファイルのTXTレコードタイプの値がフルサービスリゾルバを経由したのち，スタブリゾルバまで応答される．
DNS Infiltrationの流入通信を図解した様子が，図~\ref{fig:dns-infiltration}である．
このようにして，DNS Infiltrationでは，正規の名前解決の方法を用いて，インターネットから組織内へとデータを取得することができる．

% Null タイプは，厳密に定義されておらず，実験用としか表現されていない．しかし，全体のタイプのうち，20%を示す程度に頻繁に使用されるタイプのである．

\newpage
\subsection{DNSトンネリングへの既存対策}

本節では，DNSトンネリングに対するこれまでの対策手法を紹介し，検知手法として用いられるアプローチについて説明する．
最後に，それら検知アプローチを迂回する脅威モデルを示し，検知に基づくアプローチに限界があることを明らかにする．

DNSトンネリングに対して，森下らは提案されているDNSトンネリングへの対策アプローチを以下のようにまとめている~\cite{morishita}．
\begin{enumerate}
 \item DNSクエリログの取得と保存・内容の調査
 \vspace{-0.5cm}
 \item エンタープライズネットワークにおけるOP53B\footnote{OP53B : 組織外に設置されたオープンリゾルバのようなフルサービスリゾルバや権威サーバとの通信を抑止するために，組織外ネットワークを宛先とする53番ポートの通信をブロックする仕組み}の適用
 \vspace{-0.5cm}
 \item DNSファイヤーウォールの導入
\end{enumerate}

クエリログの取得は，リアルタイムではなく後に解析・調査するにためには必要不可欠である．
OP53Bの適用は，組織におけるDNS通信をイントラネットのフルサービスリゾルバに集約するのに効果が期待される．
DNSファイヤーウォールの導入は，ベンダーが開発したトンネリング通信のモデルや閾値に基づき検知またはブロックするのに効果が期待される．

% 検知に基づく手法の現在までの程度を淡々と示す．
%誰がその特徴を発見したのか
%それ特徴を用いて，どのようなテクニックで検知手法として確立させたのか
\subsubsection{特徴量}
\label{sec:pre-tunnel-feature}
従来，DNSトンネリング通信の検知には，以下に示す特徴量について統計分析を用いた閾値の算出や機械学習を用いた悪性モデルが用いられてきた．
トンネリング実装などによって発生する一般的なDNSトンネリング通信の検知にあたり，以下のような特徴を利用した手法がこれまでに多数提案されている．\newline
%長さ
%DNS Exfiltrationでは，Qnameフィールドのラベルがデータ転送のキャリアとなるため，表~\ref{tab:feature-tunnel}で示すように，転送するデータ量に比例してドメイン名は長くなる．
%また，DNS Infiltrationの場合は，応答パケットのRdataフィールドがデータ転送のキャリアとなるため，転送するデータ量に比例して肥大化する．


\hspace{-12pt}\textbf{ドメイン名の長さとクエリパケットのサイズ}\\
\hspace{12pt}クライアントからサーバ方向にデータを転送させるDNS Exfiltration手法において，転送キャリアとなるドメイン名が注入されるデータ量に応じて長くなる~\cite{vern}．
例えば，DNS Exfiltrationにおいて，一回あたりのデータ転送量を増加させる場合，Qnameフィールドのドメイン長もそれに比例して長くなり，結果としてパケットサイズも増加するという具合である．
DNS Infiltrationにおいても同様で，一回あたりのデータ転送量を増加させる場合，Rdataフィールド内のデータ量も大きくなり，応答パケットのサイズが増加する．

\input{table/feature-tunnel}

%同一ドメインあたりのクエリ頻度
\hspace{-12pt}\textbf{同一ドメインあたりのトラフィック頻度}\\
\hspace{12pt}DNSトンネリングでは，一度に転送できるデータ量に限界があるため，目的のデータを全て転送するには分割する必要がある．
トンネリング実装のように対話的にシェルコマンドを実行する通信の場合，トラフィック頻度は極めて高頻度になる．
また，サイズの大きいデータをDNS Exfiltrationを用いて転送する場合も同様に，複数のパケットに分割されたデータを転送するにあたって，多数のトラフィックが発生することになる．\newline

%レコードタイプ
\hspace{-12pt}\textbf{リソースレコードのタイプ}\\
\hspace{12pt}理論的に全てのリソースレコードを用いてデータを転送することは可能であるが，第~\ref{sec:dns-infiltration}項で示すように，使用するレコードタイプによって転送できるデータ量は大きく異なる．
表~\ref{tab:infil-rtype}で示すように，実際のトンネリング実装におけるDNS Infiltarationを目的とする通信では，AやAAAAなどは使われず，CNAMEやTXTが主に使用される．
AやAAAAなどのレコードタイプが使用されない背景には，数字のみの文字列制約が厳しさと最大のデータサイズに小さいことが考えられる．
TXTの最大サイズが253bytesであるのに対して，Aが4bytesでAAAAが32bytesなのは明らかに小さいことが確認できる．
他方で，表~\ref{tab:distribution-rtype}で示すように，通常のインターネットの利活用において使用されるレコードタイプに極端な分布の偏りがあることが知られている．
Herrymannら~\cite{Herrymann}は，2010年1月1日から6月30日までの期間において，大学構内に設置されたフルサービスリゾルバによるDNSログデータを収集した．
結果が示すように，ドメイン名に対するアドレス解決の通信が全体の89.407\%を占めていることが確認できる．
以上のことから，TXTやCNAMEといった任意の文字列を注入できるレコードタイプは効率的なデータ転送を実現できる反面，レコードタイプとして使用頻度低いという特性から，データ転送と秘匿性がトレードオフの関係にあることがわかる．

\input{table/distribution-rtype}

%これは，新規登録のドメイン名のみしか対応していないようだ
%Tatangら~\cite{tatang}が，2017年7月30日から9月1日までの期間にて，DNSサーバ間の通信パッシブDNS
%
%\input{table/distribution-rr}
%による調査では，表~\ref{tab:distribution-rr}で示す通り
\newpage
\hspace{-12pt}\textbf{パケットの応答ステータス}\\
\hspace{12pt}DNSのヘッダーは，図~\ref{fig:dns-header}で示すようなフィールドを持っており，問い合わせに対して，表~\ref{tab:dns-rcode}のようなステータス情報を応答する．
第~\ref{sec:bypass-method}項で示すような検知迂回手法を使う場合を除いて，
通常のDNS Exfiltrationでは，権威サーバが未知のデータがクラアントから転送される．
そのため，クライアントからの問い合わせには，コンテンツ不在を意味する``NXDomain"が応答される．
応答パケットのステータスが``NXDomain"であるとき，DNS Exfiltrationの可能性がある．
%表に書き換えることが可能である
\begin{figure}[h]
 \centering
 \includegraphics[width=10.0cm]{figure/dns-header.png}
 \caption{DNSのヘッダー(bytes)}
 \label{fig:dns-header}
\end{figure}

\input{table/rcode}

%Qnameにおける文字列分布とエントロピー
% 結局Baseエンコーディングは，単に文字列をマッピングさせているだけなので，一方向性ではないので，オリジナルの文字列の分布と変化はない．
\hspace{-12pt}\textbf{ドメイン名に含まれる文字列の出現頻度}\\
\hspace{12pt}Bornら~\cite{born}は，ドメイン名に使用されている文字列の分布について，流布しているトンネリング実装と正規のDNS通信について調査した．
その結果，正規のドメイン名が英語における文字列の出現分布と相関があるのに対して，トンネリング実装によって生成されるドメイン名における文字列の出現頻度では相関がみられず，文字列の出現頻度はランダムとなる傾向にある．

%どのようめ手法を用いて，DNSトンネリング検知に取り組んできたのかを説明し，次の検知迂回手法の足がかりにする
%例えば，クラスタリングなのか，機械学習なのか，統計的な手法なのか
%ツール依存であり汎用性がないことを述べたい
%これまでに提案されてきたDNSトンネリングの検知手法は，第~\ref{sec:pre-tunnel-feature}項で述べるような特徴量に基づいている．


%全セクションで述べられるような検知手法を迂回する手法を述べ，既存の検知手法の限界を示し，アーキテクチャの変更の必要性を論じる
\subsubsection{検知迂回の脅威モデル}
\label{sec:bypass-method}
%パフォーマンスを下げる手法(Low Latency)
%DNSエイリアスに対応づける手法
% 慣習的に命名されるラベル(Naming Convention)に意味を持たせることによって，例えば1byteの情報を持たせること
%特別Alexaなどの人気ラベルを調査しなくてもいいのかもしれない
% 既存研究における課題として，ツール限定型の手法では汎用性がない
% しかし，これまでに提案されてきた手法は，Low throughput手法に対して十分ではない機能しない可能性がある
第~\ref{sec:pre-tunnel-feature}項で述べる特徴量に基づき通信を監視することで，Iodineに代表されるトンネリング実装の通信を検知するのは，既存の検知手法で十分対処することは可能であると考えられる．
しかし，秘匿性を高めたDNSトンネリング通信に対しては，既存の検知手法では十分でない場合が考えられる．
例えば，DNSトンネリングの秘匿性を高める手法には，一回の問い合わせで転送するデータサイズを小さくする方法が考えられる．
従来の検知手法では，通常のDNS通信の統計的な分布から外れる異常通信として検知する．
データサイズを小さくするということは，一般のDNSクエリに使用されるようなドメイン長や応答パケットサイズに調整するということである．
この場合，従来のトンネリング実装などと比べて転送効率は下がる代わりに，パケットは一般のトラフィックに極めて類似することができる．

このように異常通信の特徴になる要素を削減することで，通常のインターネットの利用時に見られる入力ミスによって生じる通信に分類される通信クラスに模倣するというものである．
さらに，トラフィックの頻度の抑える手法を組み合わせることが考えられる．
第~\ref{sec:pre-tunnel-feature}項で述べるようにトラフィックの頻度に基づいて異常を検知するアプローチは広く利用されているが，DNSの通信においてはトラフィック量が肥大化しやすく長期間ログが取得されることは稀であることが予想される．
APTに代表される攻撃では，攻撃手法の解析などを回避するために，極めて高いモチベーションでこのような秘匿技術が用いられることが予想される．
現在の検知に基づく対策では，このような秘匿通信に対処するには課題がある．
Asafらは，システムのメモリやディスクを追加の特徴量とすることによって，そのような秘匿性を高めたトンネリング通信を検知する手法を提案している~\cite{asaf}．
しかし，Asafらの提案手法では，リアルタイム性が考慮されていない．
攻撃者にとって，秘匿手法によって小分けされたデータが情報という意味のあるものになったタイミングで情報流出という目的は達成される．
すなわち，情報流出の本質的な対策には，検知に基づく事後対応ではなく未然に抑止することが求められる．
